<app-modal
  [config]="modalConfig"
  [contentTemplate]="transferFormTemplate"
  [leftButtons]="getLeftButtons()"
  [rightButtons]="getRightButtons()"
  (buttonClicked)="handleButtonClick($event)">
</app-modal>

<ng-template #transferFormTemplate>
  <div class="modal-content-wrapper">
    <!-- Step Indicator -->
    <app-step-indicator 
      [steps]="steps" 
      [activeStep]="currentStep"
      [completedSteps]="Array.from(completedSteps)">
    </app-step-indicator>

    <!-- Step Content -->
    <div class="step-content">
      <!-- Step 1: Transfer Details -->
      <div class="tab-content" *ngIf="isStepActive(1)">
        <form [formGroup]="transferDetailsForm">
          <!-- From and To Branch -->
          <div class="form-row">
            <div class="form-group">
              <label class="field-label">From Branch <span class="required-asterisk">*</span></label>
              <app-input-dropdown
                [options]="branches"
                [config]="{
                  placeholder: 'Select source branch',
                  searchable: true
                }"
                (selectionChanged)="transferDetailsForm.patchValue({ fromBranch: $event })">
              </app-input-dropdown>
            </div>

            <div class="form-group">
              <label class="field-label">To Branch <span class="required-asterisk">*</span></label>
              <app-input-dropdown
                [options]="branches"
                [config]="{
                  placeholder: 'Select destination branch',
                  searchable: true
                }"
                (selectionChanged)="transferDetailsForm.patchValue({ toBranch: $event })">
              </app-input-dropdown>
            </div>
          </div>

          <!-- Transfer Type and Priority -->
          <div class="form-row">
            <div class="form-group">
              <label class="field-label">Transfer Type <span class="required-asterisk">*</span></label>
              <app-input-dropdown
                [options]="transferTypes"
                [config]="{
                  placeholder: 'Select transfer type',
                  searchable: false
                }"
                (selectionChanged)="transferDetailsForm.patchValue({ transferType: $event })">
              </app-input-dropdown>
            </div>

            <div class="form-group">
              <label class="field-label">Priority Level <span class="required-asterisk">*</span></label>
              <app-input-dropdown
                [options]="priorityLevels"
                [config]="{
                  placeholder: 'Select priority',
                  searchable: false
                }"
                (selectionChanged)="transferDetailsForm.patchValue({ priorityLevel: $event })">
              </app-input-dropdown>
            </div>
          </div>

          <!-- Requested By and Date -->
          <div class="form-row">
            <app-input-text
              [config]="{
                label: 'Requested By',
                placeholder: 'Name of requester',
                required: true,
                type: 'text'
              }"
              [value]="transferDetailsForm.get('requestedBy')?.value"
              (valueChanged)="transferDetailsForm.patchValue({ requestedBy: $event })">
            </app-input-text>

            <app-input-text
              [config]="{
                label: 'Expected Transfer Date',
                required: true,
                type: 'date'
              }"
              [value]="transferDetailsForm.get('expectedDate')?.value"
              (valueChanged)="transferDetailsForm.patchValue({ expectedDate: $event })">
            </app-input-text>
          </div>

          <!-- Reason for Transfer -->
          <app-input-text
            [config]="{
              label: 'Reason for Transfer',
              placeholder: 'Explain why this transfer is needed',
              required: true,
              type: 'text',
              rows: 4,
              description: true,
              helperText: 'Provide a detailed explanation for this transfer request'
            }"
            [value]="transferDetailsForm.get('reason')?.value"
            (valueChanged)="transferDetailsForm.patchValue({ reason: $event })">
          </app-input-text>

          <!-- Additional Notes -->
          <app-input-text
            [config]="{
              label: 'Additional Notes',
              placeholder: 'Optional additional information',
              type: 'text',
              rows: 3
            }"
            [value]="transferDetailsForm.get('additionalNotes')?.value"
            (valueChanged)="transferDetailsForm.patchValue({ additionalNotes: $event })">
          </app-input-text>
        </form>
      </div>

      <!-- Step 2: Select Products -->
      <div class="tab-content" *ngIf="isStepActive(2)">
        <app-item-selector
          [config]="itemSelectorConfig"
          [availableItems]="availableProducts"
          [selectedItems]="selectedProductItems"
          (selectedItemsChanged)="onSelectedItemsChanged($event)">
        </app-item-selector>
      </div>

      <!-- Step 3: Review & Submit -->
      <div class="tab-content" *ngIf="isStepActive(3)">
        <h3>Transfer Summary</h3>

        <div class="summary-box">
          <div class="summary-row">
            <div class="summary-col">
              <label>From:</label>
              <span>{{ getFromBranchName() }}</span>
            </div>
            <div class="summary-col">
              <label>To:</label>
              <span>{{ getToBranchName() }}</span>
            </div>
          </div>

          <div class="summary-row">
            <div class="summary-col">
              <label>Transfer Type:</label>
              <span>{{ getTransferTypeLabel(transferDetailsForm.get('transferType')?.value || '') }}</span>
            </div>
            <div class="summary-col">
              <label>Priority:</label>
              <span class="priority-badge" [class]="getPriorityBadgeClass(transferDetailsForm.get('priorityLevel')?.value || '')">
                {{ getPriorityLabel(transferDetailsForm.get('priorityLevel')?.value || '') }}
              </span>
            </div>
          </div>
        </div>

        <!-- Products Table -->
        <h4>Products to Transfer:</h4>
        <div class="table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>SKU</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Value</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedProductItems">
                <td>{{ item.title }}</td>
                <td>{{ item.subtitle }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-right">{{ formatCurrency(item.price || 0) }}</td>
                <td class="text-right">{{ formatCurrency((item.price || 0) * (item.quantity || 1)) }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="total-box">
          <span>Total Transfer Value:</span>
          <span class="total-value">{{ formatCurrency(getTotalValue()) }}</span>
        </div>
      </div>
    </div>
  </div>
</ng-template>
